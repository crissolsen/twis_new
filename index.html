<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>This Week in Sedgefield</title>
    <!-- PWA Meta Tags (for "Add to Homescreen" functionality) -->
    <meta name="theme-color" content="#df6a0f">
    <link rel="apple-touch-icon" href="logo.png">
    <link rel="manifest" href="data:application/manifest+json;base64,eyJuYW1lIjoiUG9kY2FzdCBGZWVkIFZpZXdlciIsInNob3J0X25hbWUiOiJQb2RjYXN0cyIsImRlc2NyaXB0aW9uIjoiQW4gaW5zdGFsbGFibGUgd2ViIGFwcCB0byBicm93c2UgYW5kIGxpc3RlbiB0byBwb2RjYXN0IGZlZWRzLiIsInN0YXJ0X3VybCI6Ii4iLCJkaXNwbGF5Ijoic3RhbmRhbG9uZSIsImJhY2tncm91bmRfY29sb3IiOiIjZjNmNGY2IiwidGhlbWVfY29sb3IiOiIjNDMzOGNhIiwiaWNvbnMiOlt7InNyYyI6ImxvZ28ucG5nIiwic2l6ZXMiOiIxOTJ4MTkyIiwidHlwZSI6ImltYWdlL3BuZyJ9LHsic3JjIjoibG9nby5wbmciLCJzaXplcyI6IjUxMng1MTIiLCJ0eXBlIjoiaW1hZ2UvcG5nIn1dfQ==">
    
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Custom styles */
        body {
            font-family: 'Inter', sans-serif;
        }
        .prose p {
            margin-bottom: 1em;
        }
        /* Hide the default audio player */
        .custom-audio-player audio {
            display: none;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="container mx-auto p-4 md:p-8 max-w-4xl">
        <!-- Header Section -->
        <header id="podcast-header" class="mb-8 p-6 bg-white rounded-xl shadow-md text-center hidden">
            <img id="podcast-image" src="logo.png" alt="Podcast Cover Art" class="w-32 h-32 rounded-lg mx-auto mb-4 shadow-lg object-cover">
            <h1 id="podcast-title" class="text-3xl md:text-4xl font-bold text-gray-900"></h1>
            <p id="podcast-description" class="text-gray-600 mt-2"></p>
        </header>

        <!-- Episodes container -->
        <main id="episodes-container">
            <!-- Loading Spinner -->
            <div id="loader" class="flex justify-center items-center py-20">
                <div class="animate-spin rounded-full h-16 w-16 border-b-4 border-indigo-600"></div>
            </div>
            <!-- Error Message -->
            <div id="error-message" class="hidden text-center p-8 bg-red-100 text-red-700 rounded-lg shadow-md">
                <h2 class="text-2xl font-semibold">Oops! Something went wrong.</h2>
                <p class="mt-2">We couldn't fetch the podcast feed. Please check the URL or try again later.</p>
            </div>
        </main>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // The RSS feed URL provided by the user
            const RSS_URL = 'https://anchor.fm/s/76069728/podcast/rss';
            const PROXY_URL = 'https://corsproxy.io/?';

            const episodesContainer = document.getElementById('episodes-container');
            const loader = document.getElementById('loader');
            const errorMessage = document.getElementById('error-message');
            
            const podcastHeader = document.getElementById('podcast-header');
            const podcastTitle = document.getElementById('podcast-title');
            const podcastDescription = document.getElementById('podcast-description');
            const podcastImage = document.getElementById('podcast-image');
            
            let currentPlayingAudio = null;

            async function fetchPodcastFeed() {
                try {
                    const response = await fetch(PROXY_URL + RSS_URL);
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    const str = await response.text();
                    const data = new window.DOMParser().parseFromString(str, "text/xml");

                    const channelTitle = data.querySelector("channel > title")?.textContent || 'Podcast Feed';
                    const description = data.querySelector("channel > description")?.textContent || 'No description available.';
                    const imageUrl = data.querySelector("channel > image > url")?.textContent;
                    
                    podcastTitle.textContent = channelTitle;
                    podcastDescription.textContent = description;
                    if (imageUrl) podcastImage.src = imageUrl;
                    podcastHeader.classList.remove('hidden');

                    const items = data.querySelectorAll("item");
                    let html = '';

                    items.forEach((item, index) => {
                        const title = item.querySelector("title")?.textContent || "No Title";
                        const description = item.querySelector("description")?.textContent || "No description available.";
                        const pubDateStr = item.querySelector("pubDate")?.textContent;
                        const enclosure = item.querySelector("enclosure");
                        const audioUrl = enclosure ? enclosure.getAttribute('url') : null;
                        const pubDate = pubDateStr ? new Date(pubDateStr).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' }) : 'No date';
                        const escapedTitle = title.replace(/"/g, '&quot;');

                        html += `
                            <article class="bg-white rounded-xl shadow-md overflow-hidden mb-6">
                                <div class="p-6 md:p-8">
                                    <p class="text-sm text-indigo-600 font-semibold mb-1">${pubDate}</p>
                                    <h2 class="text-2xl font-bold text-gray-900 mb-3">${title}</h2>
                                    <div class="text-gray-700 leading-relaxed prose">${description}</div>
                                    ${audioUrl ? `
                                    <div class="custom-audio-player mt-6" data-title="${escapedTitle}">
                                        <audio preload="metadata" src="${audioUrl}"></audio>
                                        <div class="flex items-center gap-3">
                                            <button class="play-pause-btn p-3 rounded-full bg-orange-600 text-white shadow-lg hover:bg-indigo-700 transition-colors focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2">
                                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                                            </button>
                                            <div class="flex-grow flex items-center gap-2">
                                                <span class="current-time-display text-sm font-medium text-gray-600">00:00</span>
                                                <div class="progress-bar-container bg-gray-200 rounded-full h-2 flex-grow cursor-pointer group">
                                                    <div class="progress-bar bg-indigo-500 h-2 rounded-full relative" style="width: 0%;">
                                                        <div class="absolute right-0 top-1/2 -mt-1.5 -mr-1.5 w-3 h-3 bg-white border-2 border-indigo-600 rounded-full opacity-0 group-hover:opacity-100 transition-opacity"></div>
                                                    </div>
                                                </div>
                                                <span class="duration-display text-sm font-medium text-gray-600">00:00</span>
                                            </div>
                                        </div>
                                    </div>
                                    ` : '<p class="text-red-500 mt-4">Audio not available for this episode.</p>'}
                                </div>
                            </article>
                        `;
                    });

                    loader.style.display = 'none';
                    episodesContainer.innerHTML = html;
                    setupCustomAudioPlayers();

                } catch (error) {
                    console.error("Failed to fetch RSS feed:", error);
                    loader.style.display = 'none';
                    errorMessage.classList.remove('hidden');
                }
            }

            function formatTime(seconds) {
                const minutes = Math.floor(seconds / 60);
                const secs = Math.floor(seconds % 60);
                return `${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
            }
            
            function setupCustomAudioPlayers() {
                const players = document.querySelectorAll('.custom-audio-player');
                
                const playIcon = `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>`;
                const pauseIcon = `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 9v6m4-6v6m7-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>`;
                
                players.forEach(player => {
                    const audio = player.querySelector('audio');
                    const playPauseBtn = player.querySelector('.play-pause-btn');
                    const progressBar = player.querySelector('.progress-bar');
                    const progressBarContainer = player.querySelector('.progress-bar-container');
                    const currentTimeDisplay = player.querySelector('.current-time-display');
                    const durationDisplay = player.querySelector('.duration-display');
                    let lastSaveTime = 0;

                    playPauseBtn.addEventListener('click', () => {
                        if (audio.paused) {
                            audio.play();
                        } else {
                            audio.pause();
                        }
                    });

                    audio.addEventListener('play', () => {
                        playPauseBtn.innerHTML = pauseIcon;
                        if (currentPlayingAudio && currentPlayingAudio !== audio) {
                            currentPlayingAudio.pause();
                        }
                        currentPlayingAudio = audio;
                        updateMediaSession();
                    });

                    audio.addEventListener('pause', () => {
                        playPauseBtn.innerHTML = playIcon;
                    });
                    
                    audio.addEventListener('loadedmetadata', () => {
                        durationDisplay.textContent = formatTime(audio.duration);
                        const savedTime = localStorage.getItem(audio.src);
                        if (savedTime) audio.currentTime = parseFloat(savedTime);
                    });
                    
                    audio.addEventListener('timeupdate', () => {
                        progressBar.style.width = `${(audio.currentTime / audio.duration) * 100}%`;
                        currentTimeDisplay.textContent = formatTime(audio.currentTime);

                        if (Date.now() - lastSaveTime > 5000) {
                            if (audio.currentTime > 0 && !audio.ended) {
                                localStorage.setItem(audio.src, audio.currentTime);
                            } else {
                                localStorage.removeItem(audio.src);
                            }
                            lastSaveTime = Date.now();
                        }
                    });

                    progressBarContainer.addEventListener('click', (e) => {
                        const rect = progressBarContainer.getBoundingClientRect();
                        const clickX = e.clientX - rect.left;
                        const percentage = clickX / rect.width;
                        audio.currentTime = audio.duration * percentage;
                    });
                });
            }

            function updateMediaSession() {
                if (!('mediaSession' in navigator) || !currentPlayingAudio) return;
                
                const episodeTitle = currentPlayingAudio.closest('.custom-audio-player').getAttribute('data-title') || 'Unknown Title';
                const podcastName = podcastTitle.textContent || 'Unknown Podcast';
                const artworkUrl = podcastImage.src || '';

                navigator.mediaSession.metadata = new MediaMetadata({
                    title: episodeTitle,
                    artist: podcastName,
                    album: podcastName,
                    artwork: [{ src: artworkUrl, sizes: '150x150', type: 'image/jpeg' }]
                });

                navigator.mediaSession.setActionHandler('play', () => currentPlayingAudio.play());
                navigator.mediaSession.setActionHandler('pause', () => currentPlayingAudio.pause());
                navigator.mediaSession.setActionHandler('seekbackward', () => { currentPlayingAudio.currentTime -= 10; });
                navigator.mediaSession.setActionHandler('seekforward', () => { currentPlayingAudio.currentTime += 10; });
            }

            fetchPodcastFeed();
        });
    </script>

</body>
</html>

